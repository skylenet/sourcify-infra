{{- if .Values.filesystemImport.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: db-fs-import
spec:
  template:
    spec:
      restartPolicy: Never
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: dedicated
                  operator: In
                  values:
                  - sourcify-static
      containers:
        - name: fs-import
          env:
          {{- toYaml .Values.filesystemImport.env | nindent 10 }}
          image: "{{ .Values.filesystemImport.image.registry }}/{{ .Values.filesystemImport.image.repository }}:{{ .Values.filesystemImport.image.tag }}"
          command: ["bash", "-ac"]
          #args: ["sleep infinity"]
          args:
            - >-
              npm run sourcify:database import-repo /data/contracts
          imagePullPolicy: "{{ .Values.filesystemImport.image.pullPolicy }}"
          volumeMounts:
            - mountPath: /data/repository
              name: data
      nodeSelector:
        dedicated: sourcify-static
      terminationGracePeriodSeconds: 60
      tolerations:
        - effect: NoSchedule
          key: dedicated
          operator: Equal
          value: sourcify-static
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: sourcify-repository-default-xfs
{{- end }}
